---
title: "Exercise 1"
author: "Adam Sulak, Onder Akacik, Arda Ergin"
date: "2024-02-22"
output:
  pdf_document: default
  html_document: default
---

```{r}
options(digits=3)

library(dplyr)
library(ggplot2)
library(car)
library(corrplot)
library(glmnet)
color_choice <- "Dark2"
```

# Exercise 2

In this part, let the column *Birthweight* be the response variable and let the variables *Length, Headcirk, Gestation, mage, mnosig, mheight, mppwt, fage, fedyrs, fnosig, fheight* be the potential predictors.

```{r}
data <- read.csv("Birthweight.csv")
```

## Question 2a)

a)  Investigate the problem of potential and influence points, and the problem of collinearity.

```{r}
model <- lm(
    Birthweight ~ Length + Headcirc + Gestation + mage + mnocig + mheight + mppwt + fage + fedyrs + fnocig + fheight,
    data = data
)
#model <- lm(Birthweight ~ ., data = data)
summary(model)
```

```{r}
# par(mfrow=c(2,2))
plot(model)

# 
resid_ordered <- order(abs(residuals(model)))
u = rep(0,length(resid_ordered))
u[length(resid_ordered)] = 1
# 
cooks.distance(model)
plot(cooks.distance(model), type="b")

#forbeslm_42 = lm(y~x+u11); summary(forbeslm11)
```

Collinearity:

```{r}
car::vif(model)
```

no variables have a VIF value that is higher than 5

```{r}
# Calculate correlation matrix
cor_matrix <- cor(data[, -c(1,3)]) # Exclude response variable Birthweight

# Plot the correlation matrix
corrplot(cor_matrix, 
         method = "circle", type = "upper", tl.col = "black", tl.cex = 0.6)
```

## Question 2b)

b)  Use the step-down method to possibly reduce the number of explanatory variables. Comment on your findings. (Check the model assumptions only for the resulting model.)

```{r}
step_down_model <- step(model, direction = 'backward')
summary(step_down_model)
par(mfrow = c(1,2))
plot(step_down_model)
```

## Question 2c)

c)  Determine 95% confidence and prediction intervals for *Birthweight* using the resulting model from b) for the average values of all the predictors in that model.

```{r}
step_down_model <- lm(Birthweight ~ Gestation + Headcirc, data = data)

head_mean <- mean(data$Gestation)
gest_mean <- mean(data$Headcirc)

df <- data.frame(Gestation = gest_mean, Headcirc = head_mean)

ci <- predict(step_down_model, newdata = df, interval = 'confidence')
pi <- predict(step_down_model, newdata = df, interval = 'prediction')


ci; pi
```

## Question 2d)

d)  Now apply the LASSO method along the lines outlined in the lecture to select the relevant variables (features) for predicting the response *Birthweight* (with default parameters as in the lecture and *lambda=lambda.1se*). Compare the prediction by the selected LASSO model with that by the model form b). Comment. (You will need to install the R-package *glmnet*, which is not included in the standard distribution of R. Also beware that in general a new run may deliver a new model.)

```{r}
x <- subset(data, select = -Birthweight)
y <- data$Birthweight

train=sample(1:nrow(x),0.67*nrow(x))
x_train=x[train,]; y_train=y[train]
x_test=x[-train,]; y_test = y[-train]

y_predict_lm=predict(step_down_model,newdata=data[-train,]) # predict for the test rows
mse_lm=mean((y_test-y_predict_lm)^2)# prediction quality by the linear model

lasso_model <- glmnet(x_train, y_train, alpha = 1)


lasso_cv <- cv.glmnet(
    as.matrix(x_train),
    y_train,
    alpha = 1,
    type.measure="mse",
    nfolds=5
)

lasso_pred1=predict(lasso_model,s=lasso_cv$lambda.min,newx=as.matrix(x_test))
lasso_pred2=predict(lasso_model,s=lasso_cv$lambda.1se,newx=as.matrix(x_test))
mse1_lasso=mean((y_test-lasso_pred1)^2)
mse2_lasso=mean((y_test-lasso_pred2)^2)


plot(lasso_model, xvar="lambda", label = TRUE)
plot(lasso_model, xvar="dev", label = TRUE)
plot(lasso_cv)
coef(lasso_cv, s= lasso_cv$lambda.1se)
# coef(lasso_cv_model, s= lasso_cv_model$lambda.min)

mse_lm; mse1_lasso; mse2_lasso
```

## Question 2e)

In this part, consider the binary column *lowbwt* as the main variable of interest to investigate the effect of the predictors *Gestation, smoker* and *mage35* (disregard all the other columns) on the baby weight.

e) Do smoking mothers seem to have lighter babies? Do older mothers seem to have lighter babies? To possibly support your answer(s), study the data and give a few (\>1) summaries (graphics or tables).

```{r}


# smoke_model_all <- lm( lowbwt ~ Gestation+smoker+mage35, data=data)
# # summary(smoke_model_all)
# 
# # manual step down
# m1 <- lm(lowbwt ~ Gestation+smoker, data=data)
# m2 <- lm(lowbwt ~ Gestation, data=data)
# # summary(m1); summary(m2)
# 
# # automatic step down
# smoke_step_down <- step(smoke_model_all, direction = 'backward')
# summary(smoke_step_down)
# plot(smoke_step_down)
table <- xtabs(lowbwt ~ smoker + mage35, data=data)
table
summary(table)
# chisq.test(table)

data$smoker <- as.factor(data$smoker)
data$mage35 <- as.factor(data$mage35)

boxplot(Birthweight ~ smoker, data=data)
boxplot(Birthweight ~ mage35, data=data)
```

Using drop down methods we conclude age has no significance. We select Gestation and smoker parameters.

## Question 2f)

To investigate the effect of the predictors on the baby weight, apply a logistic regression model (no interactions). Interpret the results in terms of odds, comment, compare to e).

```{r}
smokert <- xtabs(~smoker, data=data)
barplot(xtabs(lowbwt~smoker,data=data)/smokert)

log_model <- glm(lowbwt ~ smoker + mage35, data=data, family='binomial')
summary(log_model)

log_model2 <- glm(lowbwt ~ smoker, data=data, family='binomial')
summary(log_model2)
```

## Question 2g)

g) Investigate the interaction of predictor *Gestation* with *smoker*, and the interaction of *Gestation* with *mage35* (one interaction at a time). From this and f), choose a resulting model.

## Question 2h)

h) For the resulting model from g), estimate the probability of low baby weight for each combination of levels of the involved factors and the gestation of 40 weeks.

## Question 2i)

i) Another approach to address the questions in e) would be to apply a contingency table test. Implement the relevant test(s). Is this approach wrong? Name both an advantage and a disadvantage of this approach as compared to the one from f).
